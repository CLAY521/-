(window.webpackJsonp=window.webpackJsonp||[]).push([["c0c7c76d30bd"],{vb1273:function(e,j,M){"use strict";M.r(j),function(s){M.d(j,"TextEditor",function(){return S});var e,t,n,i,o,r,a,l=M("vb152"),k=M.n(l),x=M("vb143"),c=M("vb154"),u=M("vb195"),d=M("vb103"),y=M.n(d),b=M("vb114"),v=(M("vb147"),M("vb148"),M("vb112"),M("vb164"),M("vb167"),M("vb113"),M("vb119"),M("vb116")),g=(M("vb155"),M("vb118"),M("vb120"),M("vb174"),M("vb121"),M("vb117"),M("vb115"),M("vb111"),M("vb126"),M("vb125"),M("vb142")),I=(M("vb537"),M("vb139")),C=M("vb444"),w=M("vb138"),p=M("vb650"),h=M("vb488"),m=M("vb955"),O=(M("vb129"),M("vb223"),M("vb214"),M("vb232"),M("vb187"),M("vb225"),M("vb224"),M("vb128"),M("vb122"),M("vb233"),M("vb234"),M("vb235"),M("vb123"),M("vb236"),M("vb193"),M("vb237"),M("vb238"),M("vb124"),M("vb239"),M("vb104"),M("vb159"),M("vb240"),M("vb134"),M("vb131"),M("vb226"),M("vb241"),M("vb110"),M("vb242"),M("vb127"),M("vb132"),M("vb227"),M("vb135"),M("vb228"),M("vb229"),M("vb133"),M("vb243"),M("vb262"),M("vb244"),M("vb245"),M("vb246"),M("vb247"),M("vb194"),M("vb248"),M("vb249"),M("vb201"),M("vb260"),M("vb267"),M("vb250"),M("vb136"),M("vb251"),M("vb130"),M("vb252"),function(o){function r(){var e;Object(x.ov)(this,r);for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return(e=o.call.apply(o,[this].concat(n))||this).deserialize=function(e){var t=e.node,n=e.deltaSet,i=e.zoneId;if(!t)return n;var o=t.getAttribute("data-meta-block-props");if(o){var r,a=JSON.parse(o),s=a.blockType,l=a.props,c=null==l||null===(r=l.fileInfo)||void 0===r?void 0:r.name,d=new w.ZoneDelta;s===x.Dz.FILE_CARD_BLOCK&&(d.insert(c),n.replace(i,d))}return n},e}return Object(x.bu)(r,o),r}(w.Plugin)),R=function e(t){var i=this;Object(x.ov)(this,e),this.aceClickEvent=function(e,t){var n=t.event;n.detail<3||(3===n.detail&&i._editor.selection.selectAll(),n.preventDefault())},this._editor=t.editor},f=!1,E=!1,H="BITABLE_TEXT_EDITOR_CONTAINER_ID_PREFIX",S=(e=Object(b.connect)(function(e){return{shareable:Object(x.jH)(e)}},{},null,{forwardRef:!0}),t=Object(x.zx)(x.Ax.MentionIconHelper),n=Object(x.zx)(x.Ax.ConvertLinkHelper),e((o=function(t){function i(e){var f,n;return Object(x.ov)(this,i),(f=t.call(this,e)||this).unmounted=!1,f.defaultEditorValue=null,Object(x.Bx)(f,"mentionIconHelper",r,Object(x.Cx)(f)),Object(x.Bx)(f,"convertLinkHelper",a,Object(x.Cx)(f)),f.supplementMentionId=function(e,t,n){if(t.some(function(e){return Object(x.LH)(e)})){var o=e&&e.data&&e.data.entities&&e.data.entities.users,i=f.props,r=i.renderer,a=i.bitableStore,s=r.getActiveTableId(),l=a.base.getTableById(s),c=n.recordId,d=n.fieldId;if(o&&c&&d){var u=t,b=l&&l.getCellValue(c,d),v=!1;if(u&&u.length){var p=Object(x.kH)(u,b);u.forEach(function(e){var t=e.token;if(Object(x.LH)(e)){var n=o[t];if(n){if(p&&Array.isArray(b)){var i=Object(x.lH)(e,b);-1!==i&&(b[i].mentionId=n)}e.mentionId=n,v=!0}}}),v&&f.executeSetRecordAction(p?b:u,n)}}}},f.executeSetRecordAction=(n=Object(x.uY)(k.a.mark(function e(t,n){var i,o,r,a,s,l,c,d;return k.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=f.props,o=i.executeAction,r=i.tableId,a=i.viewId,i.editable){e.next=3;break}return e.abrupt("return",{result:x.Ey.None});case 3:return s=n.recordId,l=n.fieldId,c=n.fieldType,d=[],t&&!Object(u.a)(t)&&t.forEach(function(e){var t=Object.assign({},e);Object(x.LH)(e)&&(delete t.block_notify,delete t.not_notify),d.push(t)}),e.next=8,o(function(){return{cmd:x.Fy.SetRecord,tableId:r,viewId:a,recordId:s,data:Object(x.Ww)({},l,{type:c,value:d.length?d:null})}});case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}},e)})),function(e,t){return n.apply(this,arguments)}),f.initEditorReact=function(e){(f.editorReact=e).setSelectionToLastCharacter||(e.setSelectionToLastCharacter=function(){Object(C.c)(this.getEditor())}),e.replaceEditorValue||(e.replaceEditorValue=function(e){var t=this.getEditor();Object(C.b)(t,e,p.a)}),e.getSegmentArray||(e.getSegmentArray=function(){var e=this.getEditor();return e.callStack.inCallStackIfNecessary("getSegment",function(){e.fastIncorp()}),Object(h.g)(e)})},f.setTextEditorRef=function(e){f.textEditorRef=e},f.onKeyDown=function(e){var t=e.shiftKey,n=e.altKey,i=e.keyCode,o=e.metaKey,r=e.ctrlKey;if(x.rx.mac){var a=[o,r];r=a[0],o=a[1]}if(!(r||o||t||n)&&(f.props.disableEnter&&i===x.sx.Enter&&!f.isMentionBoxVisible()||i===x.sx.Tab)){var s=f.props.renderer;return e.stopImmediatePropagation(),e.preventDefault(),void(s.keybindingService&&s.keybindingService.dispatch(new x.mH(e)))}if(i!==x.sx.Esc||r||o||t||n){if(!r&&!o&&(i>=x.sx.Space&&i<=x.sx.F15||i===x.sx.Ime)){var l=f.props.onChange;l&&l()}}else f.isMentionBoxVisible()&&(e.ignoreKeybinding=!0)},f.onMouseEnter=function(e){return f.setState({popoverVisible:!0})},f.onMouseLeave=function(e){return f.setState({popoverVisible:!1})},f.bindDomEvent=function(){f.props.editable&&!x.rx.isMobile&&f.textEditorRef.addEventListener("keydown",f.onKeyDown,!0),f.props.popoverStr&&(f.textEditorRef.addEventListener("mouseenter",f.onMouseEnter),f.textEditorRef.addEventListener("mouseleave",f.onMouseLeave))},f.unbindDomEvent=function(){f.props.editable&&!x.rx.isMobile&&f.textEditorRef.removeEventListener("keydown",f.onKeyDown,!0),f.props.popoverStr&&(f.textEditorRef.addEventListener("mouseenter",f.onMouseEnter),f.textEditorRef.addEventListener("mouseleave",f.onMouseLeave))},f.setHiddenFocusElement=function(e){f.hiddenFocusElement=e},f.handleSecureLink=function(e,t){if(e.preventDefault(),t){var n=x.ob.CommonUtil.checkSecureLink&&x.ob.CommonUtil.checkSecureLink(t);Object(x.UQ)(n||t)}},f.handleNotifyUser=function(e){var t=f.props.tableId;x.ob.EventEmitter&&x.ob.EventEmitter.emit(x.QC.ProfileNotify,t,e)},f.handleEditorClick=function(){var e,t,n,i=Object(x.nH)(null===(e=f.props.field)||void 0===e?void 0:e.allowedEditModes),o=i[x.oH.Manual],r=i[x.oH.Scan],a=null===(t=f.props.renderer)||void 0===t||null===(n=t.getActiveView)||void 0===n?void 0:n.call(t),s=a&&"form"===x.Cz[a.type]?x.Bc.CCMBitableFormClick:x.Bc.CcmBitableCardClick;r&&x.cz.collectBitableEvent(s,{click:x.py.InputScan,scan_manual:o?x.pH.MANUAL_ON:x.pH.MANUAL_OFF})},f.state={offsetY:0,pluginLoaded:E,popoverVisible:!1,editorRenderConfig:x.qH},f.logger=x.rH.createLog("textEditor"),f}return Object(x.bu)(i,t),Object(x.Pw)(i,[{key:"componentDidMount",value:function(){var e=Object(x.uY)(k.a.mark(function e(){var t;return k.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.bindDomEvent(),this.setEditorRenderConfig(),E||!x.ob.loadAditPlugin){e.next=8;break}return e.next=5,x.ob.loadAditPlugin();case 5:E=!0,this.setupBlockServices(),this.unmounted||this.setState({pluginLoaded:!0});case 8:null===(t=this.editorReact)||void 0===t||t.setCopyable(this.props.copyable);case 9:case"end":return e.stop()}},e,this)}));function t(){return e.apply(this,arguments)}return t}()},{key:"UNSAFE_componentWillReceiveProps",value:function(e){var t;this.props.copyable!==e.copyable&&(null===(t=this.editorReact)||void 0===t||t.setCopyable(this.props.copyable))}},{key:"componentDidUpdate",value:function(){this.editorReact&&this.defaultEditorValue&&(this.setEditorValue(this.defaultEditorValue),this.defaultEditorValue=null)}},{key:"componentWillUnmount",value:function(){this.unmounted=!0,this.unbindDomEvent()}},{key:"setupBlockServices",value:function(){f||(x.ob.BlockExternalServices.setupBlockServices&&x.ob.BlockExternalServices.setupBlockServices(),f=!0)}},{key:"setEditorValue",value:function(e){var t=this.editorReact;if(t)try{var n=Object(p.c)(t.getEditor(),this.mentionIconHelper,e||"");t.replaceEditorValue(n),this.setEditorRenderConfig()}catch(e){this.logger.error("set editor value error",{error:e}),x.hy.ravenCatch(e)}else this.defaultEditorValue=e}},{key:"setEditorRenderConfig",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=Object(x.sH)(this);t=Object.assign({},t,{},e),Object(c.a)(t,this.state.editorRenderConfig)||this.setState({editorRenderConfig:t})}},{key:"setDefaultValue",value:function(){this.setEditorValue(this.props.value)}},{key:"isMentionBoxVisible",value:function(){return!(!this.mention||!this.mention.docMention)&&this.mention.docMention.isMentionBoxVisible()}},{key:"segmentToText",value:function(e){return e?e.reduce(function(e,t){return e+t.text},""):""}},{key:"mentionNotify",value:function(){var n=Object(x.uY)(k.a.mark(function e(i,o){var t,n,r,a,s,l,c,d,u,b,v,p,f,h,m,E,y,g=this;return k.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i){e.next=2;break}return e.abrupt("return");case 2:if(n=o.recordId,r=o.fieldId,a=this.props,s=a.renderer,l=a.bitableStore,c=a.shareable,d=s.getActiveTableId(),u=s.getActiveViewId(),b=l.base.getTableById(d),v=null===(t=x.ob.MentionHelper)||void 0===t?void 0:t.mentionV2Enabled,f=[],h=[],m=i.reduce(function(e,t){if(Object(x.tH)(t)&&(t.mentionNotify&&(t.block_notify?t.block_notify&&h.push(t):v&&(e.includes(t.token)||t.token===window.User.id)||e.push(t.token)),t.mentionId&&(p=t.mentionId),b)){var n={userId:t.token,name:t.name||"",enName:t.en_name||"",avatarUrl:t.link};b.setUserItem(n,!0)}return e},[]),!x.ob.MentionHelper.checkUserListNotNotify){e.next=16;break}return e.next=14,x.ob.MentionHelper.checkUserListNotNotify(m);case 14:(E=e.sent)&&0<E.length&&(f=i.filter(function(e){return 0<=E.indexOf(e.token)}),m=m.filter(function(e){return E.indexOf(e)<0}));case 16:if((0<f.length||0<h.length)&&Object(x.AH)({notNotifyUsers:f,blockedUsers:h}),0!==m.length){e.next=19;break}return e.abrupt("return");case 19:if(Object(x.WH)(l,y={tableId:d,viewId:u,recordId:n||"",fieldId:r||""},x.VH.TextEditor)){e.next=23;break}return e.abrupt("return");case 23:setTimeout(Object(x.uY)(k.a.mark(function e(){var t,n;return k.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!v){e.next=7;break}return t=m.map(function(e){var t;return(null==b||null===(t=b.getUserItemById(e))||void 0===t?void 0:t.name)||""}),e.next=4,Object(x.zH)(l,s,m,t,{position:y,from:x.VH.TextEditor,query:{mentionId:p},permission:{shareable:c}});case 4:l.base.eventEmitter.emit(x.Yx.AfterMentionNotify,{tableId:d,toUsers:m}),e.next=11;break;case 7:return e.next=9,Object(x.UH)(l,m,y,x.VH.TextEditor);case 9:n=e.sent,g.supplementMentionId(n,i,o);case 11:case"end":return e.stop()}},e)})),1e3);case 24:case"end":return e.stop()}},e,this)}));function e(e,t){return n.apply(this,arguments)}return e}()},{key:"tryResetEditor",value:function(){if((!this.editorReact||this.editorReact.listView)&&this.editorReact){var e=this.editorReact.getEditor();e&&e.blur(),e&&e.getInnerContainer()&&(this.setEditorValue(null),this.setState({offsetY:0}))}}},{key:"generateMentionId",value:function(e){return e&&!Object(u.a)(e)&&e.forEach(function(e){if(Object(x.tH)(e)&&!e.mentionId){var t=x.ob.MentionHelper.genMentionId();e.mentionId=t}}),e}},{key:"onEndEdit",value:function(){var t=Object(x.uY)(k.a.mark(function e(t){var n,i,o,r,a,s,l,c,d,u,b,v,p,f,h;return k.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=this.editorReact){e.next=3;break}return e.abrupt("return");case 3:if(null===(n=this.mention)||void 0===n||null===(i=n.closeMention)||void 0===i||i.call(n),t||!this.props.editable){e.next=26;break}a=this.props,s=a.tableId,l=a.recordId,c=a.fieldId,d=a.field,u=a.bitableStore,b=a.viewId,v=null===(r=x.ob.MentionHelper)||void 0===r?void 0:r.mentionV2Enabled,p=null,f={recordId:l,fieldId:c,fieldType:d.type};try{p=Object(m.a)(o),Object(x.yH)(this.props.relativeClass,d.fieldUIType,p)}catch(e){this.logger.error("getSegmentArray error",{error:e}),x.hy.ravenCatch(e)}if(this.props.cardSyncMode===x.tx.OnDemand){e.next=14;break}this.tryResetEditor(),e.next=19;break;case 14:if(!p){e.next=19;break}return e.next=17,this.convertLinkHelper.executeConvertToMention({cellValue:p,tableId:s,viewId:b,recordId:l,fieldId:c});case 17:(h=e.sent)&&(p=h,this.setEditorValue(p),Object(x.yH)(this.props.relativeClass,d.fieldUIType,p));case 19:return v&&(p=this.generateMentionId(p)),e.next=22,this.executeSetRecordAction(p,f);case 22:e.sent.result===x.Ey.Success&&(this.mentionNotify(p,f),this.convertLinkHelper.executeConvertToMention({cellValue:p,tableId:s,viewId:b,recordId:l,fieldId:c,collaCommandManager:u.getCommandManager()})),e.next=27;break;case 26:this.tryResetEditor();case 27:case"end":return e.stop()}},e,this)}));function e(e){return t.apply(this,arguments)}return e}()},{key:"focus",value:function(){if(this.props.editable&&this.editorReact){var e=document.querySelector(".etherpad-container-wrapper"),t=e?e.scrollTop:0,n=this.editorReact.getEditor();n&&n.focus(),this.editorReact.setSelectionToLastCharacter(),e&&(e.scrollTop=t),x.rx.safari&&setTimeout(function(){e&&(e.scrollTop=t)})}else this.hiddenFocusElement&&this.hiddenFocusElement.focus()}},{key:"beforeStartEdit",value:function(e){var t;if(!e&&!1===Object(x.nH)(null===(t=this.props.field)||void 0===t?void 0:t.allowedEditModes)[x.oH.Manual]){var n,i,o=null===(n=this.props.renderer)||void 0===n?void 0:n.activeBitableWidget,r=null==o||null===(i=o.getActiveGridWidget)||void 0===i?void 0:i.call(o).getCover();if(r){var a=r.mapToGlobal(new v.FPoint(r.width/2,0));o.events.emit(x.kC.ShowTooltip,{x:a.x,y:a.y,title:s("Bitable_Barcode_ScanViaMobile_Tooltip"),showDelay:1}),r.addListener(v.FEventType.Destroy,function(){return o.events.emit(x.kC.HideTooltip,{animate:!0}),!1})}x.cz.collectBitableEvent(x.Bc.CcmBitableScanWarningView)}}},{key:"onStartEdit",value:function(e,t,n){var i=(null==n?void 0:n.from)===x.uH.LookUp||(null==n?void 0:n.from)===x.uH.NoPermissionContainer;this.beforeStartEdit(i),i&&this.setEditorRenderConfig({showRightButton:!1}),!t&&this.props.editable||(this.setEditorValue(e),this.editorReact&&this.editorReact.setSelectionToLastCharacter())}},{key:"fixLayout",value:function(){if(this.textEditorRef){var e=this.textEditorRef.getBoundingClientRect(),t=document.body.clientHeight,n=0;e.bottom>t&&(n=e.bottom-t+x.vH),this.state.offsetY!==n&&this.setState({offsetY:n})}}},{key:"EditorReactComponent",get:function(){var e,t,o=this;if(!this.state.pluginLoaded)return null;var n=this.props,i=n.placeholder,r=n.outerPlaceholder,a=n.isCardEdit,s=n.editable,l=n.disableLink,c=n.bitableStore,d=n.tableId,u=(this.state.editorRenderConfig||{}).showOuterPlaceholder,b=Object(x.nH)(null===(e=this.props.field)||void 0===e?void 0:e.allowedEditModes)[x.oH.Scan],v=null===(t=x.ob.MentionHelper)||void 0===t?void 0:t.mentionV2Enabled,p=Object(x.wH)(c,d),f=Object(x.Ry)(c),h=u?r:i,m=null==c?void 0:c.base.isPro(),E=s?h:Object(x.xH)({isFieldEditablePermission:p,placeholder:h,isPro:m});return y.a.createElement(C.a,{className:"b-small-scrollbar bitable-text-editor-content ".concat(this.props.editorContainerId),registerPlugin:function(e){var t,n,i=[];return l||(o.mention=new x.ob.AditPlugins.Mention({editor:e,source:f,showable:!0,type:"bitable",hoverArea:o.props.editorContainerId?".".concat(o.props.editorContainerId):"",displayLargePopover:!0,container:"#".concat(o.props.editorContainerId||"mainContainer"),boxWidth:280,notifyUser:v?o.handleNotifyUser:void 0}),i.push(o.mention),i.push(new x.ob.AditPlugins.HyperLinks({editor:e,type:"bitable",onClick:o.handleSecureLink})),null!==(t=(n=x.ob.MentionHelper).getUDMentionEnable)&&void 0!==t&&t.call(n)&&!b&&i.push(new x.ob.AditPlugins.CommonMention(e,"".concat(o.props.editorContainerId||"mainContainer"),{suiteType:x.ob.MentionHelper.suiteTypeNum,source:f,token:x.ob.CommonUtil.getToken(),defaultNeedNotification:!v&&void 0},{viewPortContainer:".app-main-container"}))),i.push(new x.ob.AditPlugins.Undo({editor:e}),new x.ob.AditPlugins.Redo({editor:e}),new x.ob.AditPlugins.Indent({editor:e}),new w.TextNodeDeserializer,new w.BlockElementDeserializer,new O,new I.BlockPlugin({editor:e,blockManager:new I.BlockManager([new g.AtUserCreator({ExternalServices:x.ob.BlockExternalServices.AtUserCreator})])}),new R({editor:e})),i},idleWorkTimer:!1,tagsIgnoreToParse:{table:!0},onInit:function(e){o.initEditorReact(e)},placeholder:a?E:h,editable:s,bus:x.pG})}},{key:"render",value:function(){var e=this.props,t=e.recordId,n=e.fieldId,i=e.RightButton,o=(this.state.editorRenderConfig||{}).showRightButton,r="".concat(H,"_").concat(t,"_").concat(n);return y.a.createElement("div",{className:"bitable-text-editor-container",id:r,style:Object.assign({},this.props.style,{transform:"translateY(-".concat(this.state.offsetY,"px)")}),ref:this.setTextEditorRef,onClick:this.handleEditorClick},y.a.createElement("input",{readOnly:!0,className:"hidden-input",ref:this.setHiddenFocusElement}),y.a.createElement("div",{className:"bitable-editor-wrapper b-ud-scrollbar"},y.a.createElement("div",{className:"editor-component"},this.EditorReactComponent),o?i(this):null))}}]),i}(y.a.Component),r=Object(x.lz)(o.prototype,"mentionIconHelper",[t],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),a=Object(x.lz)(o.prototype,"convertLinkHelper",[n],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),i=o))||i)}.call(this,M("vb163"))},vb955:function(e,t,n){"use strict";n.d(t,"a",function(){return r});var i=n("vb650"),o=n("vb143");n("vb147"),n("vb103"),n("vb148");function r(e){var t=e.getSegmentArray({linkReg:o.GH});return Object(i.b)(t)}}}]);
//# sourceMappingURL=//slardar.bytedance.net/api_v2/browser/jserr/get_sourcemap?bid=docs_pc&js_filename=c0c7c76d30bd.b6cd7e5a27.chunk.js